# Old style, all the config in one place.

framework:
    test: true
    secret: 'Bloubigoulba'
    php_errors:
        log: true
    messenger:
        # Uncomment this (and the failed transport below) to send failed messages to this transport for later handling.
        # failure_transport: failed

        transports:
            async: 'in-memory:///' # Should be a real async transport. For testing we cheat.
            queuing: 'in-memory:///'

        routing:
            'JoliCode\Elastically\Messenger\MultipleIndexationRequest': async
            'JoliCode\Elastically\Messenger\IndexationRequest': queuing
    http_client:
        scoped_clients:
            elasticsearch.client:
                base_uri: 'http://localhost:9999'

elastically:
    connections:
        default:
            client:
                hosts:
                    - 'localhost:9999'
            mapping_directory: '%kernel.project_dir%/tests/configs'

            # Size of the bulk sent to Elasticsearch (default to 100)
            bulk_size:               100

            # Mapping between an index name and a FQCN
            index_class_mapping:
                hop: JoliCode\Elastically\Tests\Messenger\TestDTO
        special:
            client:
                hosts:
                    - 'localhost:9999'
                transport_config:
                    http_client: 'Psr\Http\Client\ClientInterface'
            mapping_directory: '%kernel.project_dir%/tests/configs'
            index_class_mapping:
                hop: JoliCode\Elastically\Tests\Messenger\TestDTO

services:
    _defaults:
        public: true
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    messenger.transport.queuing.test:
        public: true
        alias: messenger.transport.queuing

    messenger.transport.async.test:
        public: true
        alias: messenger.transport.async

    dummy:
        class: \stdClass
        arguments:
            - '@Symfony\Component\Messenger\MessageBusInterface'

    psr_es_client:
        class: Symfony\Component\HttpClient\Psr18Client
        arguments:
            $client: '@elasticsearch.client'

    JoliCode\Elastically\Messenger\IndexationRequestSpoolSubscriber:
        arguments:
            - '@messenger.transport.queuing'
            - '@messenger.default_bus'
        tags:
            - { name: kernel.event_subscriber }

    elastically.default.client.test:
        public: true
        alias: elastically.default.client

    elastically.default.index_name_mapper.test:
        public: true
        alias: elastically.default.index_name_mapper

    elastically.default.mapping.provider.test:
        public: true
        alias: elastically.default.mapping.provider

    elastically.special.client.test:
        public: true
        alias: elastically.special.client
